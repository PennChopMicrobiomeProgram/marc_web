{% extends 'base.html' %}

{% block body %}
<div class="container py-5">
<div class="d-flex flex-row">
  <div class="d-flex w-50 p-5 m-5 border border-black">
    <form class="d-flex flex-column w-100" method="POST" action="{{ url_for('query') }}">
      <label class="p-2">Custom Query</label>
      <textarea id="query" name="query" class="w-100 p-2" rows="10">{{ query }}</textarea>
      <button type="submit" id="submit" class="my-2 p-2">Submit</button>
    </form>
  </div>

  <div class="d-flex w-50 p-5 m-5">
    {% for model in models %}
    <div class="d-flex flex-column w-100 p-2 border border-black">
      <h4>{{ model.__table__.name }}</h4>
      <ul>
        {% for field in model.__table__.columns %}
          <li>{{ field }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </div>
</div>
</div>

{% if error is defined %}
<div class="alert alert-danger">
  <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% if query %}
<div class="d-flex w-50 px-5">
  <form action="{{ '/download' }}" method="POST" enctype="multipart/form-data">
    <div class="form-group">
      <input type="hidden" name="query" value="{{ query }}">
      <button type="submit" class="btn btn-success">Download metadata</button>
    </div>
  </form>
</div>
<div>
    <table class="display" id="results">
      <thead>
        <tr></tr>
      </thead>
      <tbody></tbody>
    </table>
</div>

<script type="text/javascript">
$(document).ready(function () {
    const sql = `{{ query|tojson|safe }}`;
    if (!sql) return;

    $.post(
        '{{ url_for('api_query') }}',
        { query: sql, draw: 1, start: 0, length: 20 },
        function(resp) {
            const header = $('#results thead tr');
            header.empty();
            resp.columns.forEach(c => header.append(`<th>${c}</th>`));
            const columns = resp.columns.map(c => ({ data: c }));

            $('#results').DataTable({
                serverSide: true,
                processing: true,
                ajax: {
                    url: '{{ url_for('api_query') }}',
                    type: 'POST',
                    data: function(d) { d.query = sql; }
                },
                columns: columns,
                data: resp.data,
                deferLoading: resp.recordsTotal,
                pageLength: 20,
                lengthChange: false,
                pagingType: 'full_numbers',
                stateSave: true,
            });

            $("#results_filter").appendTo('#results_summary');
            $("#results_info").addClass("span-12");
            $("#results_paginate").addClass("span-12 last");
        },
        'json'
    );
});
</script>
{% endif %}
{% endblock %}