{% extends 'base.html' %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block body %}
<div class="container-fluid mt-3">
  <ul class="nav nav-tabs" id="assemblyTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="assemblies-tab" data-bs-toggle="tab" data-bs-target="#assembliesTab" type="button" role="tab" aria-controls="assembliesTab" aria-selected="true">
        Assemblies
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="isolate-stats-tab" data-bs-toggle="tab" data-bs-target="#isolateStatsTab" type="button" role="tab" aria-controls="isolateStatsTab" aria-selected="false">
        Isolate Stats
      </button>
    </li>
  </ul>
  <div class="tab-content pt-4" id="assemblyTabContent">
    <div class="tab-pane fade show active" id="assembliesTab" role="tabpanel" aria-labelledby="assemblies-tab">
      <div id="assemblies_summary" class="summary span-24 last">
        <h2>Assemblies</h2>
      </div>

      <div class="d-flex flex-row">
        <div class="d-flex p-5">
          <table class="display" id="assemblies">
            <thead>
              <tr>
                <th>ID</th>
                <th>Isolate ID</th>
                <th>Metagenomic Sample ID</th>
                <th>Metagenomic Run ID</th>
                <th>Nanopore Path</th>
                <th>Run Number</th>
                <th>Sunbeam Version</th>
                <th>SBX SGA Version</th>
                <th>Sunbeam Output Path</th>
                <th>NCBI ID</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="isolateStatsTab" role="tabpanel" aria-labelledby="isolate-stats-tab">
      <div class="container pb-4">
        <div class="row g-4">
          <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Contig Count</h5>
                <canvas id="contigCountChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Average Contig Coverage</h5>
                <canvas id="avgCoverageChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Genome Size</h5>
                <canvas id="genomeSizeChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="row g-4 mt-1">
          <div class="col-12">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Completeness vs Contamination</h5>
                <div style="height: 220px">
                  <canvas id="contaminationCompletenessChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
$(document).ready(function () {
    const assemblyUrl = "{{ url_for('show_assembly', assembly_id=0)[:-1] }}";
    const oTable = createServerDataTable('#assemblies', '{{ url_for('api_assemblies') }}', [
        { data: 'id', render: function(d) { return '<a href="' + assemblyUrl + d + '">' + d + '</a>'; } },
        { data: 'isolate_id' },
        { data: 'metagenomic_sample_id' },
        { data: 'metagenomic_run_id' },
        { data: 'nanopore_path' },
        { data: 'run_number' },
        { data: 'sunbeam_version' },
        { data: 'sbx_sga_version' },
        { data: 'sunbeam_output_path' },
        { data: 'ncbi_id' }
    ]);

    $('#assemblies_filter').appendTo('#assemblies_summary');
    $('#assemblies_info').addClass('span-12');
    $('#assemblies_paginate').addClass('span-12 last');
    oTable.draw();

    function isNumericValue(value) {
        return typeof value === 'number' && !Number.isNaN(value);
    }

    function buildBinConfig(values, binCount = 10) {
        const filtered = values.filter(isNumericValue);
        if (filtered.length === 0) {
            return null;
        }

        const min = Math.min(...filtered);
        const max = Math.max(...filtered);
        const range = max - min;
        const binSize = range === 0 ? 1 : range / binCount;
        const labels = Array.from({ length: binCount }, (_, idx) => {
            const start = min + idx * binSize;
            const end = start + binSize;
            const formatter = binSize >= 10 ? (num) => Math.round(num).toLocaleString() : (num) => num.toFixed(2);
            return `${formatter(start)} - ${formatter(end)}`;
        });

        return { min, binSize, binCount, labels };
    }

    function binCounts(values, binConfig) {
        if (!binConfig) return [];
        const counts = new Array(binConfig.binCount).fill(0);
        values.filter(isNumericValue).forEach((value) => {
            const binIndex = binConfig.binSize === 0 ? 0 : Math.min(binConfig.binCount - 1, Math.floor((value - binConfig.min) / binConfig.binSize));
            counts[binIndex] += 1;
        });
        return counts;
    }

    const palette = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
    const speciesKey = (metric) => metric.suspected_organism || 'Unknown';

    function hexToRgba(hex, alpha = 0.5) {
        const sanitized = hex.replace('#', '');
        const bigint = parseInt(sanitized, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function getSpeciesList(metrics) {
        return Array.from(new Set(metrics.map((metric) => speciesKey(metric)))).sort();
    }

    function renderHistogram(canvasId, metrics, valueSelector, datasetLabel, xLabel) {
        const context = document.getElementById(canvasId);
        if (!context) {
            return;
        }

        const allValues = metrics.map(valueSelector).filter(isNumericValue);
        const binConfig = buildBinConfig(allValues);
        if (!binConfig) {
            return;
        }

        const speciesList = getSpeciesList(metrics);
        const datasets = speciesList
            .map((species, idx) => {
                const values = metrics
                    .filter((m) => speciesKey(m) === species)
                    .map(valueSelector)
                    .filter(isNumericValue);
                if (values.length === 0) return null;
                const color = palette[idx % palette.length];
                return {
                    label: species,
                    data: binCounts(values, binConfig),
                    backgroundColor: hexToRgba(color, 0.5),
                    borderColor: color,
                    borderWidth: 1,
                };
            })
            .filter(Boolean);

        if (!datasets.length) {
            return;
        }

        new Chart(context, {
            type: 'bar',
            data: {
                labels: binConfig.labels,
                datasets,
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: 'bottom' },
                    title: { display: false },
                },
                scales: {
                    x: {
                        title: { display: true, text: xLabel },
                        ticks: { maxRotation: 45, minRotation: 45 },
                        stacked: true,
                    },
                    y: {
                        title: { display: true, text: 'Assemblies' },
                        beginAtZero: true,
                        precision: 0,
                        stacked: true,
                    },
                },
            },
        });
    }

    function renderScatter(metrics) {
        const context = document.getElementById('contaminationCompletenessChart');
        if (!context) {
            return;
        }

        const speciesList = getSpeciesList(metrics);
        const datasets = speciesList
            .map((species, idx) => {
                const points = metrics
                    .filter(
                        (m) => speciesKey(m) === species && isNumericValue(m.contamination) && isNumericValue(m.completeness)
                    )
                    .map((m) => ({
                        x: m.contamination,
                        y: m.completeness,
                        assemblyId: m.assembly_id,
                    }));
                if (!points.length) return null;
                const color = palette[idx % palette.length];
                return {
                    label: species,
                    data: points,
                    backgroundColor: color,
                };
            })
            .filter(Boolean);

        if (!datasets.length) {
            return;
        }

        new Chart(context, {
            type: 'scatter',
            data: { datasets },
            options: {
                parsing: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const { x, y, assemblyId } = context.raw;
                                return `Assembly ${assemblyId}: Contamination ${x}, Completeness ${y}`;
                            },
                        },
                    },
                    legend: { display: true, position: 'bottom' },
                },
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Contamination' },
                    },
                    y: {
                        title: { display: true, text: 'Completeness' },
                    },
                },
                onClick: (_event, elements) => {
                    if (!elements.length) return;
                    const { assemblyId } = elements[0].element.$context.raw;
                    if (assemblyId) {
                        window.location.href = `${assemblyUrl}${assemblyId}`;
                    }
                },
            },
        });
    }

    fetch('{{ url_for('api_assembly_metrics') }}')
        .then((response) => response.json())
        .then((payload) => payload.data || [])
        .then((metrics) => {
            renderHistogram(
                'contigCountChart',
                metrics,
                (m) => m.contig_count,
                'Contig Count',
                'Contig Count (binned)'
            );
            renderHistogram(
                'avgCoverageChart',
                metrics,
                (m) => m.avg_contig_coverage,
                'Average Contig Coverage',
                'Average Coverage (binned)'
            );
            renderHistogram(
                'genomeSizeChart',
                metrics,
                (m) => m.genome_size,
                'Genome Size',
                'Genome Size (binned)'
            );
            renderScatter(metrics);
        });
});
</script>
{% endblock %}
